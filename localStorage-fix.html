<!DOCTYPE html>
<html>
<head>
    <title>localStorage Fix Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .output { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
        button { padding: 8px 16px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 300px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>localStorage Fix Tool</h1>
    
    <div class="section">
        <h3>1. Clear All AI Settings</h3>
        <button onclick="clearAllSettings()">Clear Everything</button>
        <div id="clear-output" class="output"></div>
    </div>
    
    <div class="section">
        <h3>2. Set Fresh OpenAI Key</h3>
        <input type="password" id="fresh-key" placeholder="sk-...">
        <button onclick="setFreshKey()">Set Fresh Key</button>
        <div id="fresh-output" class="output"></div>
    </div>
    
    <div class="section">
        <h3>3. Verify Settings</h3>
        <button onclick="verifySettings()">Verify Everything</button>
        <div id="verify-output" class="output"></div>
    </div>

    <script>
        function clearAllSettings() {
            const output = document.getElementById('clear-output');
            try {
                // Clear all AI-related localStorage keys
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('ai') || key.includes('synapse') || key.includes('settings'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                output.innerHTML = `<span class="success">✅ Cleared ${keysToRemove.length} keys:\n${keysToRemove.join('\n')}</span>`;
            } catch (error) {
                output.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }
        
        function setFreshKey() {
            const keyInput = document.getElementById('fresh-key');
            const output = document.getElementById('fresh-output');
            const key = keyInput.value.trim();
            
            if (!key || !key.startsWith('sk-')) {
                output.innerHTML = '<span class="error">❌ Please enter a valid OpenAI API key (starts with sk-)</span>';
                return;
            }
            
            try {
                // Create fresh settings object
                const freshSettings = {
                    mode: 'beginner',
                    provider: 'openai',
                    model: 'gpt-4o',
                    languageId: 'typescript',
                    temperature: 0.2,
                    maxTokens: 2048,
                    stream: true,
                    timeoutMs: 30000,
                    safetyLevel: 'standard',
                    keys: {
                        openai: key,
                        ollama: 'http://localhost:11434'
                    }
                };
                
                localStorage.setItem('synapse.ai.settings.v2', JSON.stringify(freshSettings));
                
                output.innerHTML = `<span class="success">✅ Fresh settings saved successfully!</span>`;
                keyInput.value = '';
            } catch (error) {
                output.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }
        
        function verifySettings() {
            const output = document.getElementById('verify-output');
            try {
                const raw = localStorage.getItem('synapse.ai.settings.v2');
                if (!raw) {
                    output.innerHTML = '<span class="error">❌ No settings found</span>';
                    return;
                }
                
                const settings = JSON.parse(raw);
                const hasOpenAI = !!settings.keys?.openai;
                const keyLength = settings.keys?.openai?.length || 0;
                
                output.innerHTML = `<span class="success">✅ Settings verified:
Provider: ${settings.provider}
Model: ${settings.model}
OpenAI Key Present: ${hasOpenAI}
Key Length: ${keyLength}
Keys Object: ${JSON.stringify(settings.keys, null, 2)}</span>`;
            } catch (error) {
                output.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }
        
        // Auto-verify on load
        window.onload = verifySettings;
    </script>
</body>
</html>
