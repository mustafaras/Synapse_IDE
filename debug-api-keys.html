<!DOCTYPE html>
<html>
<head>
    <title>API Keys Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .output { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
        button { padding: 8px 16px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 300px; }
    </style>
</head>
<body>
    <h1>API Keys Debug Tool</h1>
    
    <div class="section">
        <h3>Current localStorage Contents</h3>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <div id="localStorage-output" class="output"></div>
    </div>
    
    <div class="section">
        <h3>AI Settings V2</h3>
        <button onclick="checkAiSettings()">Check AI Settings</button>
        <div id="settings-output" class="output"></div>
    </div>
    
    <div class="section">
        <h3>Set OpenAI API Key</h3>
        <input type="password" id="openai-key" placeholder="sk-...">
        <button onclick="setOpenAIKey()">Set Key</button>
        <div id="set-key-output" class="output"></div>
    </div>
    
    <div class="section">
        <h3>Test API Key</h3>
        <button onclick="testApiKey()">Test Current Key</button>
        <div id="test-output" class="output"></div>
    </div>

    <script>
        const AI_SETTINGS_V2_STORAGE_KEY = 'synapse.ai.settings.v2';
        
        function checkLocalStorage() {
            const output = document.getElementById('localStorage-output');
            let content = 'All localStorage keys:\n';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                content += `${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}\n`;
            }
            
            output.textContent = content;
        }
        
        function checkAiSettings() {
            const output = document.getElementById('settings-output');
            try {
                const raw = localStorage.getItem(AI_SETTINGS_V2_STORAGE_KEY);
                if (!raw) {
                    output.textContent = 'No AI settings found in localStorage';
                    return;
                }
                
                const settings = JSON.parse(raw);
                output.textContent = JSON.stringify(settings, null, 2);
            } catch (error) {
                output.textContent = 'Error reading AI settings: ' + error.message;
            }
        }
        
        function setOpenAIKey() {
            const keyInput = document.getElementById('openai-key');
            const output = document.getElementById('set-key-output');
            const key = keyInput.value.trim();
            
            if (!key) {
                output.textContent = 'Please enter an API key';
                return;
            }
            
            try {
                // Load current settings
                let settings;
                const raw = localStorage.getItem(AI_SETTINGS_V2_STORAGE_KEY);
                if (raw) {
                    settings = JSON.parse(raw);
                } else {
                    settings = {
                        mode: 'beginner',
                        provider: 'openai',
                        model: 'gpt-4o',
                        languageId: 'typescript',
                        temperature: 0.2,
                        maxTokens: 2048,
                        stream: true,
                        timeoutMs: 30000,
                        safetyLevel: 'standard',
                        keys: {}
                    };
                }
                
                // Update OpenAI key
                if (!settings.keys) settings.keys = {};
                settings.keys.openai = key;
                
                // Save back to localStorage
                localStorage.setItem(AI_SETTINGS_V2_STORAGE_KEY, JSON.stringify(settings));
                
                output.textContent = 'OpenAI API key saved successfully!';
                keyInput.value = '';
            } catch (error) {
                output.textContent = 'Error saving API key: ' + error.message;
            }
        }
        
        async function testApiKey() {
            const output = document.getElementById('test-output');
            output.textContent = 'Testing API key...';
            
            try {
                const raw = localStorage.getItem(AI_SETTINGS_V2_STORAGE_KEY);
                if (!raw) {
                    output.textContent = 'No AI settings found';
                    return;
                }
                
                const settings = JSON.parse(raw);
                const openaiKey = settings.keys?.openai;
                
                if (!openaiKey) {
                    output.textContent = 'No OpenAI API key found in settings';
                    return;
                }
                
                // Test the API key
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    output.textContent = `API key is valid! Found ${data.data.length} models.`;
                } else {
                    const error = await response.text();
                    output.textContent = `API key test failed: ${response.status} - ${error}`;
                }
            } catch (error) {
                output.textContent = 'Error testing API key: ' + error.message;
            }
        }
        
        // Auto-check on load
        window.onload = function() {
            checkLocalStorage();
            checkAiSettings();
        };
    </script>
</body>
</html>
